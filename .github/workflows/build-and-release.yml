# GitHub workflow to build and release AudioMonitor WPF application
# This workflow builds the application in Release mode and creates a GitHub release with the binaries

name: Build and Release

on:
  push:
    branches:
      - main
      - master # Falls du master verwendest
    tags:
      - 'v*' # Pushes zu v* Tags
  pull_request:
    branches:
      - main
      - master # Falls du master verwendest

env:
  Solution_Name: AudioMonitorSolution\AudioMonitorSolution.sln
  Project_Path: AudioMonitorSolution\AudioMonitor.UI\AudioMonitor.UI.csproj
  Output_Directory: AudioMonitorSolution\AudioMonitor.UI\bin\Release\net8.0-windows
  Publish_Directory: AudioMonitorSolution\AudioMonitor.UI\bin\Release\net8.0-windows\publish

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write # Erforderlich zum Erstellen von Tags und Releases
      packages: read  # Beibehalten, falls für dotnet restore von GitHub Packages benötigt

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Erforderlich, um Tags abzurufen und neue zu pushen

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x' # Spezifiziere deine .NET Version

      - name: Restore Dependencies
        run: dotnet restore $env:Solution_Name

      - name: Build Project
        run: dotnet build $env:Solution_Name --configuration Release --no-restore

      - name: Run Tests
        run: dotnet test $env:Solution_Name --configuration Release --no-build --verbosity normal

      - name: Publish Project
        run: dotnet publish $env:Project_Path --configuration Release --output publish --runtime win-x64 --self-contained false --verbosity normal
        # --self-contained false, da das .NET Runtime auf dem Zielsystem erwartet wird oder mitinstalliert wird

      - name: Copy Icon if exists
        run: |
          if (Test-Path "AudioMonitorSolution\image.ico") {
            Copy-Item "AudioMonitorSolution\image.ico" "publish\image.ico"
          }
        shell: pwsh

      - name: Prepare Release Files
        run: |
          $releaseDir = "AudioMonitor-Release"
          New-Item -ItemType Directory -Path $releaseDir -Force
          # Kopiere veröffentlichte Dateien
          Copy-Item -Path "publish\*" -Destination $releaseDir -Recurse -Force
          # Erstelle ZIP-Paket
          Compress-Archive -Path $releaseDir\* -DestinationPath "AudioMonitor-Windows-x64.zip" -Force
        shell: pwsh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: AudioMonitor-Windows-x64
          path: AudioMonitor-Windows-x64.zip

      # --- Release für v*-Tags (Produktions-Release) ---
      - name: Create Release for v-Tag
        if: startsWith(github.ref, 'refs/tags/v')
        id: create_tagged_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref_name }} # github.ref_name gibt den Tag-Namen direkt
          body: "Offizielles Release für Version ${{ github.ref_name }}"
          draft: false
          prerelease: false

      - name: Upload Release Asset for v-Tag
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_tagged_release.outputs.upload_url }}
          asset_path: ./AudioMonitor-Windows-x64.zip
          asset_name: AudioMonitor-Windows-x64-${{ github.ref_name }}.zip # Eindeutiger Name mit Tag
          asset_content_type: application/zip

      # --- Pre-Release für main-Branch Pushes ---
      - name: Create Tag for Main Branch Build
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          $tagName = "dev-build-${{ github.run_number }}-${{ github.sha }}"
          echo "DEV_TAG_NAME=$tagName" | Out-File -FilePath $env:GITHUB_ENV -Append
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git tag $tagName
          git push origin $tagName
        shell: pwsh

      - name: Create Release for Main Branch Build
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        id: create_main_prerelease
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.DEV_TAG_NAME }}
          release_name: "Development Build (main #${{ github.run_number }})"
          body: "Automatisches Pre-Release vom Push auf den main-Branch. Commit: ${{ github.sha }}. Build-Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          draft: false
          prerelease: true

      - name: Upload Asset for Main Branch Release
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_main_prerelease.outputs.upload_url }}
          asset_path: ./AudioMonitor-Windows-x64.zip
          asset_name: AudioMonitor-Windows-x64-${{ env.DEV_TAG_NAME }}.zip
          asset_content_type: application/zip
